<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vite App</title>
</head>

<body>
  <!-- <script src="./fabric.min.js" type="text/javascript"></script> -->
  <script src="https://unpkg.com/fabric@latest/dist/fabric.js"></script>
  <script src="https://unpkg.com/fabric@latest/src/mixins/eraser_brush.mixin.js"></script>



  <div class="controls">
    <button id="select" type="button" onclick="changeAction(this)">select</button>
    <button id="erase" type="button" onclick="changeAction(this)">erase</button>
    <button id="undo" type="button" onclick="changeAction(this)">undo erasing</button>
    <button id="draw" type="button" onclick="changeAction(this)">draw</button>
    <button id="spray" type="button" onclick="changeAction(this)">spray</button>
  </div>
  <div>
    <div>
      <label for="a">
        background image <code>erasable</code>
      </label>
      <input id="a" type="checkbox" onchange="setBgImageErasableProp(this)">
    </div>
    <div>
      <label for="b">
        remove erased objects on <code>erasing:end</code>
      </label>
      <input id="b" type="checkbox" onchange="setErasingRemovesErasedObjects(this)">
    </div>
  </div>
  <div>
    <button type="button" onclick="toJSON()">toJSON</button>
    <button type="button" onclick="downloadImage()">to Image</button>
    <button type="button" onclick="downloadSVG()">toSVG</button>
  </div>
  <div style="display:flex;flex-direction:row;">
    <div>
      <canvas id="c" width="500" height="620"></canvas>
    </div>
    <div style="margin:0 1rem;">
      <code>erasing:end</code><br>
      <code id="output">N/A</code>
    </div>
  </div>


  <script type="text/javascript">

    let erasingRemovesErasedObjects = false;
    function changeAction(target) {
      ['select', 'erase', 'undo', 'draw', 'spray'].forEach(action => {
        const t = document.getElementById(action);
        t.classList.remove('active');
      });
      if (typeof target === 'string') target = document.getElementById(target);
      target.classList.add('active');
      switch (target.id) {
        case "select":
          canvas.isDrawingMode = false;
          break;
        case "erase":
          canvas.freeDrawingBrush = new fabric.EraserBrush(canvas);
          canvas.freeDrawingBrush.width = 10;
          canvas.isDrawingMode = true;
          break;
        case "undo":
          canvas.freeDrawingBrush = new fabric.EraserBrush(canvas);
          canvas.freeDrawingBrush.width = 10;
          canvas.freeDrawingBrush.inverted = true;
          canvas.isDrawingMode = true;
          canvas.freeDrawingBrush.color = "red";

          break;
        case "draw":
          canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
          canvas.freeDrawingBrush.width = 35;
          canvas.isDrawingMode = true;
          break;
        case "spray":
          canvas.freeDrawingBrush = new fabric.SprayBrush(canvas);
          canvas.freeDrawingBrush.width = 35;
          canvas.isDrawingMode = true;
          break;
        default:
          break;
      }
    }
    function init() {
      console.log("here");
      // canvas.setOverlayColor("rgba(0,0,255,0.4)", undefined, { erasable: false });




        // new fabric.Image.fromURL('https://upload.wikimedia.org/wikipedia/commons/1/15/Cat_August_2010-4.jpg'),




      //   new fabric.Image.fromURL('https://upload.wikimedia.org/wikipedia/commons/1/15/Cat_August_2010-4.jpg',
      //   function (img) {
      //     // img.set("erasable", false);
      //     img.scaleToWidth(480);
      //     img.clone((img) => {
      //       canvas.add(
      //         img
      //           .set({
      //             left: 400,
      //             top: 350,
      //             clipPath: new fabric.Circle({
      //               radius: 200,
      //               originX: "center",
      //               originY: "center"
      //             }),
      //             angle: 30
      //           })
      //           .scale(0.25)
      //       );
      //       canvas.renderAll();
      //     });
      //     canvas.setBackgroundImage(img);
      //     // img.set({ erasable: false });
      //     canvas.on("erasing:end", ({ targets, drawables }) => {
      //       var output = document.getElementById("output");
      //       output.innerHTML = JSON.stringify({
      //         objects: targets.map((t) => t.type),
      //         drawables: Object.keys(drawables)
      //       }, null, '\t');
      //       if (erasingRemovesErasedObjects) {
      //         targets.forEach(obj => obj.group?.removeWithUpdate(obj) || canvas.remove(obj));
      //       }
      //     })
      //     canvas.renderAll();
      //   },
      //   { crossOrigin: "anonymous" }
      // ),















     
      fabric.Image.fromURL('https://upload.wikimedia.org/wikipedia/commons/1/15/Cat_August_2010-4.jpg',
        function (img) {
          // img.set("erasable", false);
          img.scaleToWidth(480);
          img.clone((img) => {
            canvas.add(
              img
                .set({
                  left: 400,
                  top: 350,
                  clipPath: new fabric.Circle({
                    radius: 200,
                    originX: "center",
                    originY: "center"
                  }),
                  angle: 30
                })
                .scale(0.25)
            );
            canvas.renderAll();
          });

          canvas.setBackgroundImage(img);
          // img.set({ erasable: false });
          canvas.on("erasing:end", ({ targets, drawables }) => {
            var output = document.getElementById("output");
            output.innerHTML = JSON.stringify({
              objects: targets.map((t) => t.type),
              drawables: Object.keys(drawables)
            }, null, '\t');
            if (erasingRemovesErasedObjects) {
              targets.forEach(obj => obj.group?.removeWithUpdate(obj) || canvas.remove(obj));
            }
          })
          canvas.renderAll();
        },
        { crossOrigin: "anonymous" }
      );

    
    }

    const setDrawableErasableProp = (drawable, value) => {
      canvas.get(drawable)?.set({ erasable: value });
      changeAction('erase');
    };

    const setBgImageErasableProp = (input) =>
      setDrawableErasableProp("backgroundImage", input.checked);

    const setErasingRemovesErasedObjects = (input) =>
      (erasingRemovesErasedObjects = input.checked);

    const downloadImage = () => {
      const ext = "png";
      const base64 = canvas.toDataURL({
        format: ext,
        enableRetinaScaling: true
      });
      const link = document.createElement("a");
      link.href = base64;
      link.download = `eraser_example.${ext}`;
      link.click();
    };

    const downloadSVG = () => {
      const svg = canvas.toSVG();
      const a = document.createElement("a");
      const blob = new Blob([svg], { type: "image/svg+xml" });
      const blobURL = URL.createObjectURL(blob);
      a.href = blobURL;
      a.download = "eraser_example.svg";
      a.click();
      URL.revokeObjectURL(blobURL);
    };

    const toJSON = async () => {
      const json = canvas.toDatalessJSON(["clipPath", "eraser"]);
      const out = JSON.stringify(json, null, "\t");
      const blob = new Blob([out], { type: "text/plain" });
      const clipboardItemData = { [blob.type]: blob };
      try {
        navigator.clipboard &&
          (await navigator.clipboard.write([
            new ClipboardItem(clipboardItemData)
          ]));
      } catch (error) {
        console.log(error);
      }
      const blobURL = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = blobURL;
      a.download = "eraser_example.json";
      a.click();
      URL.revokeObjectURL(blobURL);
    };
    const canvas = this.__canvas = new fabric.Canvas('c');
    init();
    changeAction('erase');


  </script>


</body>

</html>





























<!-- <!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vite App</title>
</head>

<body>
  <div>
    <canvas id="canvas"></canvas>
  </div>
  <a href="" id="dwn" download>Download</a>
  <button id="undo">Undo</button>
  <button id="redo">Redo</button>
  <script type="module" src="/main.js"></script>
</body>

</html> -->





<!-- <html xmlns="http://www.w3.org/1999/xhtml">

<head></head>

<body onload=InitThis();>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
  <script type="text/javascript">

    var mousePressed = false;
    var lastX, lastY;
    var ctx;

    function InitThis() {
      console.log("here");
      ctx = document.getElementById('myCanvas').getContext("2d");
      $('#myCanvas').mousedown(function (e) {
        mousePressed = true;
        Draw(e.pageX - $(this).offset().left, e.pageY - $(this).offset().top, false);
      });

      $('#myCanvas').mousemove(function (e) {
        if (mousePressed) {
          Draw(e.pageX - $(this).offset().left, e.pageY - $(this).offset().top, true);
        }
      });

      $('#myCanvas').mouseup(function (e) {
        if (mousePressed) {
          mousePressed = false;
          cPush();
        }
      });

      $('#myCanvas').mouseleave(function (e) {
        if (mousePressed) {
          mousePressed = false;
          cPush();
        }
      });
      drawImage();
    }

    function drawImage() {
      var image = new Image();
      image.src = '/2.webp';
      $(image).load(function () {
        ctx.drawImage(image, 0, 0, 600, 400);
        cPush();
      });
    }

    function Draw(x, y, isDown) {
      if (isDown) {
        ctx.beginPath();
        ctx.strokeStyle = "black";
        ctx.lineWidth = $('#selWidth').val();
        ctx.lineJoin = "round";
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.closePath();
        ctx.stroke();
      }
      lastX = x;
      lastY = y;
    }

    var cPushArray = new Array();
    var cStep = -1;

    function cPush() {
      cStep++;
      if (cStep < cPushArray.length) { cPushArray.length = cStep; }
      cPushArray.push(document.getElementById('myCanvas').toDataURL());
      document.title = cStep + ":" + cPushArray.length;
    }
    function cUndo() {
      if (cStep > 0) {
        cStep--;
        var canvasPic = new Image();
        canvasPic.src = cPushArray[cStep];
        canvasPic.onload = function () { ctx.drawImage(canvasPic, 0, 0); }
        document.title = cStep + ":" + cPushArray.length;
      }
    }
    function cRedo() {
      if (cStep < cPushArray.length - 1) {
        cStep++;
        var canvasPic = new Image();
        canvasPic.src = cPushArray[cStep];
        canvasPic.onload = function () { ctx.drawImage(canvasPic, 0, 0); }
        document.title = cStep + ":" + cPushArray.length;
      }
    }




  </script>

  <div align="center">
    <canvas id="myCanvas" width="600" height="400" style="border:2px solid black"></canvas>
    <br /><br />
    <button onclick="javascript:drawImage();return false;">Restore</button>
    Line width : <select id="selWidth">
      <option value="1">1</option>
      <option value="3">3</option>
      <option value="5">5</option>
      <option value="7">7</option>
      <option value="9" selected="selected">9</option>
      <option value="11">11</option>
    </select>
    <button onclick="javascript:cUndo();return false;">Undo</button>
    <button onclick="javascript:cRedo();return false;">Redo</button>

    <button id="pen">Pen</button>
    <button id="eraser">Eraser</button>
  </div>
</body>

</html> -->